<div class="card p-3 mb-3">
	<div class="container">
		<h4 class="mt-3 mb-3">PUNTO DE VENTA</h4>
		<app-loading *ngIf="is_loading"></app-loading>
		<div class="form-row">
			<div [ngClass]="{'block':show_name_input,'col-7':true}">
				<label>Cliente</label>
				<input type="" [(ngModel)]="datosVenta.venta.cliente" (keyup)="buscarCliente($event)" class="form-control" [placeholder]="datosVenta.tipo_precio.nombre">
				<div *ngIf="search_usuario.length" class="dropdown-menu show w-100 no-selectable-text">
					<div class="dropdown-item search"><a [routerLink]="'/agregar-paciente'" class="d-block">Agregar Nuevo Usuario</a></div>
					<div *ngFor="let usuario of search_usuario" (click)="selectUsuario(usuario)">
						<div class="dropdown-item search">
							{{usuario.nombre|titlecase}}  <i class="text-muted"> {{usuario.usuario|uppercase}}</i>
						</div>
					</div>
				</div>
			</div>
			<div class="col">
				<label>Tipo Cliente</label>
				<select class="form-control col" name="tipo_precio" [ngModel]="datosVenta.venta.id_tipo_precio" (change)="changeTipoPrecio($event.target.value)">
					<option *ngFor="let tipo_precio of tipo_precios" [value]="tipo_precio.id" [selected]="datosVenta.venta.id_tipo_precio==tipo_precio.id">{{tipo_precio.nombre |  uppercase}}</option>
				</select>
			</div>
			<div *ngIf="ventas.length>0">
				<label>Ventas Pendientes</label>
				<select class="form-control col" name="tipo_precio" (change)="cambiarVenta($event.target.value)">
					<option value="">Seleccionar</option>
					<option *ngFor="let venta of ventas" [value]="venta.id">{{venta.id}} {{ venta.cliente |  uppercase}}</option>
				</select>
			</div>
		</div>

		<div class="dropdown mb-3">
			<div class="mt-3 row">
				<div class="col">
					<input type="text" (keyup)="buscar($event)" id="busqueda" [(ngModel)]="busqueda" class="form-control" placeholder="Buscar...">
				</div>
				<div *ngIf="search_loading">
					<div class="spinner-border text-primary" role="status">
						<span class="sr-only">Loading...</span>
					</div>
				</div>
			</div>
			<div *ngIf="search_servicios.length && busqueda != ''" class="dropdown-menu show w-100 no-selectable-text">
				<div *ngFor="let servicio of search_servicios;let i=index" (click)="agregarServicio(servicio)">
					<!--div *ngIf="i>0" class="dropdown-divider"></div -->
					<div class="dropdown-item search">
						{{servicio.nombre|uppercase}}
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="container mt-3 pt-3">
		<ul class="list-group">
			<li class="list-group-item"  *ngFor="let sd of datosVenta.detalles">
				<div class="row">
					<label class="col-4 form-check-label">{{sd.servicio.nombre | titlecase}}</label>
					<label class="col-4 text-center form-check-label">{{sd.detalle_venta.cantidad}}</label>
					<div class="col-4 text-right">
						<div class="btn-group" role="group">
								<button type="button" class="btn btn-primary border font-weight-bold" (click)="disminuir(sd)">-</button>
								<button type="button" class="btn btn-primary border font-weight-bold" (click)="aumentar(sd)">+</button>
								<button type="button" class="btn btn-primary border font-weight-bold" (click)="eliminar(sd)">x</button>
						</div>
					</div>
				</div>
			</li>
		</ul>
	</div>
</div>

<footer class="card w-100">
	<div class="m-auto text-center" *ngIf="procesando_pago">
		<div class="spinner-border text-success" role="status">
			<span class="sr-only">Loading...</span>
		</div>
	</div>


	<div class="row p-3">

		<div class="col-md-3">
			<div>Subtotal:</div>
			<div class="font-weight-bold">{{datosVenta.venta.subtotal| currency}}</div>
		</div>

		<div class="col-md-3">
			<div>Iva:</div>
			<div class="font-weight-bold" >{{datosVenta.venta.iva| currency}}</div>
		</div>

		<div class="col-md-3">
			<div>Total:</div>
			<div class="font-weight-bold">{{datosVenta.venta.total | currency }}</div>
		</div>

		<div class="col-md-3 mt-3 mb-3" *ngIf="datosVenta.venta.id">
			<button type="button" class="btn btn-primary btn-lg" (click)="cancelarVenta()">
				Cancelar Venta
			</button>
		</div>
		<div class="col text-center">
			<button type="button" class="btn btn-primary btn-lg  w-100" (click)="guardarVenta()" [disabled]="show_creando_venta">Pagar</button>
		</div>
	</div>
</footer>


<app-modal [(show)]="show_modal_pago">
	<div class="p-3 m-3 border-box row">

		<div class="form-group col-md-6">
			<div class="row mb-2">
				<div class="col-6">
					<label class="col-form-label">Efectivo: </label>
				</div>
				<div class="col-6">
					<input type="number" class="form-control" name="efectivo" [(ngModel)]="pago.efectivo">
				</div>
			</div>

			<div class="row mb-2">
				<div class="col-6">
					<label class="col-form-label">Dolares: </label>
				</div>
				<div class="col-6">
					<input type="number" class="form-control" name="dolares" [(ngModel)]="pago.dolares">
				</div>
			</div>
			<div class="row mb-2">
				<div class="col-6">
					<label class="col-form-label">Tarjeta: </label>
				</div>
				<div class="col-6">
					<input type="number" class="form-control" name="cheques" [(ngModel)]="pago.tarjeta">
				</div>
			</div>
		</div>

		<div class="col-md-6">
			<div class="m-auto text-center" *ngIf="procesando_pago">
				<div class="spinner-border text-success" role="status">
					<span class="sr-only">Loading...</span>
				</div>
			</div>

			<div class="row">
				<label class="col-8">Total:</label>
				<label class="col-4 text-right">{{pago.total | currency }}</label>
			</div>
			<div class="row">
				<label class="col-8">Total en Dlls:</label>
				<label class="col-4 text-right">{{pago.total/pago.tipo_cambio_dolares | currency }}</label>
			</div>
			<div class="row">
				<label class="col-10">Cantidad a Pagar:</label>
				<label class="col-2 text-right">{{infoPago.cantidad_faltante}}</label>
			</div>
			<!--div class="row">
				{{ pago.efectivo }}
				{{ pago.dolares}}
				{{ pago.tipo_cambio_dolares}}
				{{ pago.dolares*pago.tipo_cambio_dolares}}
				{{ pago.tarjeta }}
				{{ pago.cheque | currency}}
				{{ pago.deposito | currency }}
				{{ pago.total | currency }}
			</div-->
			<div *ngIf="pago.dolares>0" class="row">
				<label class="col-8">:</label>
				<label class="col-4 text-right">{{pago.dolares*pago.tipo_cambio_dolares | currency}}</label>
			</div>

			<div *ngIf="debug" class="row">
				<label class="col-8">En Dlls:</label>
				<label class="col-4 text-right">{{pago.dolares*pago.tipo_cambio_dolares |currency}}</label>
			</div>
			<div>
			</div>
			<div class="row" *ngIf="pago.dolares>0">
				<label class="col-8">Cambio En Dlls:</label>
				<label class="col-4 text-right">
					{{pago.cambio_en_dolares|currency}}
				</label>
			</div>
			<div class="row">
				<label class="col-8">Cambio:</label>
				<label class="col-4 text-right">{{calcularCambio(pago)|currency}}</label>
				<!--
				<label class="col-4">
					{{ ((0+pago.efectivo
						+(pago.dolares*pago.tipo_cambio_dolares)
						+pago.tarjeta
						+pago.cheque
						+pago.deposito - pago.total )> 0 ?
						(
							0+pago.efectivo
							+(pago.dolares*pago.tipo_cambio_dolares)
							+pago.tarjeta
							+pago.cheque
							+pago.deposito
							- pago.total
						)
						: 0 ) | currency}}
				 </label>
				-->
			</div>
		</div>
		<div>
			<!--button type="button" class="btn btn-primary" [disabled]="procesando_pago || infoPago.cantidad_faltante > 0" (click)="pagarVenta()">Pagar</button-->
			<button type="button" class="btn btn-primary" [disabled]="procesando_pago" (click)="pagarVenta()">Pagar</button>
		</div>
	</div>
</app-modal>
